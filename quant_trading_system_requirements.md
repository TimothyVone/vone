# 加密货币量化交易系统需求文档

## 1. 项目概述

### 1.1 项目背景
开发一套个人使用的加密货币量化交易系统，支持币安(Binance)和欧易(OKX)两大交易所，实现趋势跟踪、网格交易和套利三种核心策略。

### 1.2 目标用户
- 个人量化交易者（初学者水平）
- 需要自动化交易工具的投资者
- 希望降低情绪化交易影响的用户

### 1.3 核心价值
- **自动化执行**：24/7 全天候自动交易，无需人工盯盘
- **多策略支持**：支持趋势、网格、套利等多种策略
- **风险可控**：内置风险管理机制，保护本金安全
- **易于使用**：适合初学者的配置和监控系统

## 2. 功能需求

### 2.1 数据获取模块

#### 2.1.1 实时行情数据
- 支持获取实时价格数据（tick 级别）
- 支持 K 线数据（1m, 5m, 15m, 1h, 4h, 1d）
- 支持深度数据（Order Book）
- 支持 WebSocket 实时推送
- 支持多交易对同时监控

#### 2.1.2 历史数据
- 支持批量下载历史 K 线数据
- 支持数据持久化存储
- 支持数据清洗和补全

#### 2.1.3 账户数据
- 实时账户余额查询
- 持仓信息查询
- 未完成订单查询
- 历史成交记录查询

### 2.2 交易执行模块

#### 2.2.1 订单管理
- **限价单**（Limit Order）
  - 支持设置价格和数量
  - 支持只减仓（Reduce-Only）
  - 支持_postonly（挂单方手续费）

- **市价单**（Market Order）
  - 支持按数量下单
  - 支持按金额下单

- **条件单**（Conditional Order）
  - 止损单（Stop Loss）
  - 止盈单（Take Profit）
  - OCO 单（二选一订单）

- **订单管理**
  - 取消订单
  - 修改订单
  - 批量取消
  - 订单状态查询

#### 2.2.2 交易对支持
- 现货交易（Spot）
- 永续合约（Perpetual Futures）
- 杠杆交易（Margin）

### 2.3 策略引擎

#### 2.3.1 趋势跟踪策略
**技术指标支持：**
- 移动平均线（SMA, EMA）
- MACD
- RSI
- 布林带（Bollinger Bands）
- ATR（平均真实波幅）

**策略类型：**
- 双均线交叉
- 突破策略
- 动量策略

**参数配置：**
- 可配置指标参数
- 可配置开仓/平仓条件
- 可配置仓位管理

#### 2.3.2 网格交易策略
**核心功能：**
- 等差网格（固定价差）
- 等比网格（固定比例）
- 无限网格（单边持仓）
- 中性网格（双边持仓）

**参数配置：**
- 网格上限/下限
- 网格数量
- 单格投入金额
- 止盈/止损设置

**自动管理：**
- 自动生成网格订单
- 成交后自动补单
- 网格参数调整支持

#### 2.3.3 套利策略
**套利类型：**
- 跨交易所套利（币安 ↔ OKX）
- 现货-期现套利
- 三角套利（未来扩展）

**核心功能：**
- 实时价差监控
- 自动价差计算（考虑手续费和滑点）
- 套利信号触发
- 双边同时下单（尽可能减小时间差）

**参数配置：**
- 最小套利利润阈值
- 单次套利金额
- 最大持仓限制

### 2.4 回测系统

#### 2.4.1 回测引擎
- 支持历史数据回放
- 支持策略逻辑验证
- 支持手续费模拟
- 支持滑点模拟

#### 2.4.2 性能指标
- 总收益率
- 年化收益率
- 最大回撤
- 夏普比率
- 胜率
- 盈亏比
- 交易次数统计

#### 2.4.3 回测报告
- 资金曲线图表
- 持仓变化图表
- 详细交易记录
- 交易统计汇总

### 2.5 风险管理模块

#### 2.5.1 仓位管理
- **固定金额法**：每次固定金额投入
- **固定比例法**：按账户余额的固定比例
- **凯利公式**（可选）
- **马丁格尔策略**（谨慎使用，需警告）

#### 2.5.2 风险控制
- **单笔最大亏损限制**：例如不超过本金的 2%
- **日最大亏损限制**：例如不超过本金的 5%
- **最大持仓限制**：限制单个交易对的仓位
- **总仓位限制**：限制所有策略的总仓位
- **止损强制执行**：到达止损线立即平仓

#### 2.5.3 风险预警
- 账户余额不足预警
- 异常波动预警
- 系统异常预警
- 网络断开预警

### 2.6 监控和通知模块

#### 2.6.1 实时监控
- 账户总价值实时监控
- 各策略盈亏实时监控
- 持仓和未完成订单监控
- 系统运行状态监控

#### 2.6.2 日志记录
- 交易日志（所有买卖操作）
- 策略日志（策略信号生成）
- 系统日志（错误和异常）
- 性能日志（API 延迟、订单执行时间）

#### 2.6.3 通知功能
- **交易通知**
  - 开仓成功/失败
  - 平仓成功/失败
  - 止损/止盈触发

- **策略通知**
  - 策略启动/停止
  - 策略信号触发
  - 策略异常

- **风险通知**
  - 触及风险阈值
  - 异常亏损

- **通知渠道**
  - 钉钉机器人（已配置）
  - 控制台输出
  - 日志文件

### 2.7 配置管理

#### 2.7.1 API 配置
- 交易所 API Key 配置
- API Secret 配置
- 权限配置（读取、交易）

#### 2.7.2 策略配置
- 策略参数配置文件
- 支持热加载（运行时修改参数）
- 配置验证（参数合法性检查）

#### 2.7.3 运行配置
- 交易对选择
- 时间周期选择
- 运行模式（实盘/模拟盘）

## 3. 非功能需求

### 3.1 性能要求
- API 响应时间 < 100ms（不含网络延迟）
- 策略计算延迟 < 10ms
- 支持至少 10 个策略同时运行
- WebSocket 连接稳定性 > 99.9%

### 3.2 可靠性要求
- 系统异常自动恢复
- 网络断开自动重连
- 订单失败自动重试（配置次数）
- 数据持久化，重启不丢失状态

### 3.3 安全性要求
- API Key 加密存储
- 敏感信息不打印到日志
- 请求签名验证
- 防止未授权访问

### 3.4 可维护性要求
- 模块化设计，低耦合
- 代码注释完整
- 统一的日志格式
- 清晰的配置文件结构

### 3.5 可扩展性要求
- 易于添加新策略
- 易于添加新交易所
- 支持插件式架构
- 预留接口扩展能力

## 4. 系统架构

### 4.1 技术栈

#### 核心框架
- **Python 3.10+**
- **CCXT**：统一交易所 API 接口
- **pandas**：数据处理
- **numpy**：数值计算

#### 技术指标库
- **TA-Lib** 或 **pandas-ta**
- **tulip**（可选，性能更好）

#### 数据存储
- **SQLite**：轻量级，适合个人使用
  - 存储历史数据
  - 存储交易记录
  - 存储配置和状态
- **Redis**（可选）：缓存实时数据

#### 消息通知
- **钉钉 SDK** 或直接 HTTP 调用

#### 配置管理
- **YAML** 或 **JSON**：配置文件格式
- **python-dotenv**：环境变量管理

#### 日志
- **logging**：Python 标准日志库

#### 回测和可视化
- **Backtrader** 或 **VectorBT**：回测框架
- **Matplotlib** 或 **Plotly**：图表绘制

#### 异步处理
- **asyncio**：异步 I/O
- **aiohttp**：异步 HTTP 请求

### 4.2 系统分层架构

```
┌─────────────────────────────────────────┐
│           用户界面 (CLI/Web)             │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          应用层 (Application)            │
│  ┌────────────┬────────────┬──────────┐ │
│  │  策略管理器  │  任务调度器  │ 风险管理器 │ │
│  └────────────┴────────────┴──────────┘ │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          核心层 (Core)                   │
│  ┌────────────┬────────────┬──────────┐ │
│  │  策略引擎   │  回测引擎   │ 订单管理器 │ │
│  └────────────┴────────────┴──────────┘ │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          数据层 (Data)                   │
│  ┌────────────┬────────────┬──────────┐ │
│  │  数据获取器  │  数据存储   │ 缓存管理  │ │
│  └────────────┴────────────┴──────────┘ │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         接口层 (Interface)               │
│  ┌────────────┬────────────┬──────────┐ │
│  │ CCXT 适配器 │  WebSocket  │ HTTP API │ │
│  └────────────┴────────────┴──────────┘ │
└─────────────────────────────────────────┘
```

### 4.3 核心模块设计

#### 4.3.1 交易所适配器 (Exchange Adapter)
```python
class ExchangeAdapter:
    """统一交易所接口"""
    - fetch_ticker()      # 获取行情
    - fetch_ohlcv()       # 获取K线
    - create_order()      # 创建订单
    - cancel_order()      # 取消订单
    - fetch_balance()     # 查询余额
    - fetch_position()    # 查询持仓
```

#### 4.3.2 策略基类 (Strategy Base)
```python
class BaseStrategy:
    """策略基类"""
    - on_init()           # 初始化
    - on_data()           # 数据更新时触发
    - on_tick()           # Tick数据触发
    - generate_signal()   # 生成交易信号
    - on_order()          # 订单状态更新
```

#### 4.3.3 风险管理器 (Risk Manager)
```python
class RiskManager:
    """风险管理器"""
    - check_position_limit()     # 检查持仓限制
    - check_loss_limit()         # 检查亏损限制
    - calculate_position_size()  # 计算仓位大小
    - validate_order()           # 订单风险验证
```

#### 4.3.4 订单管理器 (Order Manager)
```python
class OrderManager:
    """订单管理器"""
    - place_order()        # 下单
    - cancel_order()       # 撤单
    - modify_order()       # 改单
    - get_order_status()   # 查询状态
    - handle_order_error() # 处理错误
```

## 5. 开发路线图

### Phase 1: 基础框架搭建（2-3周）
- [ ] 项目结构初始化
- [ ] CCXT 集成（币安、欧易）
- [ ] 数据获取模块（K线、账户）
- [ ] 基础订单管理功能
- [ ] 配置管理系统
- [ ] 日志系统
- [ ] 数据库设计和初始化

### Phase 2: 策略实现（3-4周）
- [ ] 策略基类设计
- [ ] 趋势跟踪策略
  - [ ] 技术指标计算模块
  - [ ] 双均线策略
  - [ ] 突破策略
- [ ] 网格交易策略
  - [ ] 等差/等比网格
  - [ ] 自动订单管理
- [ ] 套利策略
  - [ ] 跨交易所价差监控
  - [ ] 套利信号生成
  - [ ] 双边下单逻辑

### Phase 3: 风险管理和回测（2-3周）
- [ ] 风险管理模块
  - [ ] 仓位管理
  - [ ] 止损止盈
  - [ ] 风险限制
- [ ] 回测系统
  - [ ] 历史数据回放
  - [ ] 性能指标计算
  - [ ] 回测报告生成

### Phase 4: 监控和通知（1-2周）
- [ ] 实时监控面板（CLI 或 Web）
- [ ] 钉钉通知集成
- [ ] 系统健康检查
- [ ] 异常告警机制

### Phase 5: 测试和优化（2-3周）
- [ ] 模拟盘测试
- [ ] 性能优化
- [ ] 异常处理完善
- [ ] 小额实盘测试
- [ ] 文档编写

### Phase 6: 部署和运维（持续）
- [ ] 服务器部署
- [ ] 自动化启动脚本
- [ ] 监控告警
- [ ] 数据备份策略

**预计总开发时间：10-15周**

## 6. 风险提示

### 6.1 技术风险
- **API 限制**：交易所 API 可能有频率限制
- **网络延迟**：影响套利和实时策略效果
- **系统稳定性**：需要充分的异常处理

### 6.2 市场风险
- **市场波动**：极端行情可能导致巨额亏损
- **流动性风险**：大额订单可能无法成交
- **交易所风险**：交易所宕机或被黑客攻击

### 6.3 策略风险
- **过拟合**：回测效果好不代表实盘有效
- **参数敏感性**：参数设置不当可能导致亏损
- **黑天鹅事件**：无法预测的极端市场情况

### 6.4 风险控制建议
1. **从小额开始**：先用小额资金测试策略
2. **分散投资**：不要把所有资金投入单一策略
3. **设置止损**：始终设置合理的止损
4. **定期检查**：定期查看系统运行状态
5. **持续学习**：不断优化策略和系统

## 7. 数据存储设计

### 7.1 数据库表结构

#### 7.1.1 K线数据表 (klines)
```
- id: 主键
- exchange: 交易所名称
- symbol: 交易对
- timeframe: 时间周期
- timestamp: 时间戳
- open: 开盘价
- high: 最高价
- low: 最低价
- close: 收盘价
- volume: 成交量
```

#### 7.1.2 交易记录表 (trades)
```
- id: 主键
- order_id: 订单ID
- exchange: 交易所名称
- symbol: 交易对
- side: 买卖方向
- price: 成交价格
- amount: 成交数量
- fee: 手续费
- timestamp: 成交时间
- strategy: 所属策略
```

#### 7.1.3 策略状态表 (strategy_states)
```
- id: 主键
- strategy_name: 策略名称
- status: 运行状态
- config: 配置参数 (JSON)
- position: 当前持仓
- total_profit: 总盈亏
- last_update: 最后更新时间
```

### 7.2 配置文件结构

#### config.yaml
```yaml
# 交易所配置
exchanges:
  binance:
    api_key: "your_api_key"
    secret: "your_secret"
    testnet: false  # 是否使用测试网

  okx:
    api_key: "your_api_key"
    secret: "your_secret"
    password: "your_password"
    testnet: false

# 策略配置
strategies:
  - name: "trend_following"
    enabled: true
    symbol: "BTC/USDT"
    timeframe: "1h"
    config:
      fast_period: 10
      slow_period: 30
      position_size: 100

  - name: "grid_trading"
    enabled: false
    symbol: "ETH/USDT"
    config:
      upper_price: 3000
      lower_price: 2000
      grid_count: 10

# 风险管理
risk:
  max_position_ratio: 0.3    # 最大仓位比例
  max_daily_loss: 0.05       # 日最大亏损比例
  stop_loss_ratio: 0.02      # 单笔止损比例

# 通知配置
notification:
  dingtalk:
    webhook: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
    secret: "your_secret"
    enabled: true

# 日志配置
logging:
  level: "INFO"
  file: "logs/trading.log"
  console: true
```

## 8. 系统运行流程

### 8.1 系统启动流程
```
1. 加载配置文件
2. 初始化数据库连接
3. 初始化交易所连接
4. 验证 API 权限
5. 初始化策略实例
6. 启动数据流（WebSocket）
7. 启动策略引擎
8. 发送系统启动通知
```

### 8.2 策略执行流程
```
1. 接收市场数据（Tick/K线）
2. 更新技术指标
3. 策略逻辑计算
4. 生成交易信号
5. 风险验证
6. 创建订单
7. 监控订单状态
8. 更新持仓和盈亏
9. 发送通知
```

### 8.3 异常处理流程
```
1. 检测异常（网络断开、API错误等）
2. 记录错误日志
3. 尝试自动恢复
4. 如果恢复失败，发送告警通知
5. 暂停策略执行
6. 等待人工介入
```

## 9. 测试计划

### 9.1 单元测试
- 每个模块的核心函数
- 技术指标计算
- 订单逻辑
- 风险管理计算

### 9.2 集成测试
- 交易所 API 调用
- 数据存储和读取
- 策略端到端流程

### 9.3 回测测试
- 使用历史数据回测
- 验证策略逻辑正确性
- 评估性能指标

### 9.4 模拟盘测试
- 连接测试网
- 运行 1-2 周以上
- 验证稳定性

### 9.5 实盘测试
- 使用极小额资金
- 逐步放大资金
- 持续监控和优化

## 10. 未来扩展

### 10.1 更多策略
- 均值回归
- 统计套利
- 做市策略
- 高频策略

### 10.2 更多交易所
- Bybit
- Gate.io
- Coinbase
- Kraken

### 10.3 高级功能
- 机器学习预测
- 情绪指标分析
- 自动参数优化
- 多账户管理

### 10.4 用户界面
- Web Dashboard
- 移动端 App
- 可视化回测报告

## 11. 参考资料

### 11.1 官方文档
- CCXT 文档: https://docs.ccxt.com/
- 币安 API: https://binance-docs.github.io/apidocs/
- 欧易 API: https://www.okx.com/docs-v5/

### 11.2 开源项目
- Freqtrade: https://www.freqtrade.io/
- VeighNa: https://www.vnpy.com/
- Hummingbot: https://hummingbot.org/

### 11.3 学习资源
- 《量化交易：如何建立自己的算法交易事业》
- 《Python 金融大数据分析》
- 加密货币量化交易社区

---

**文档版本**: v1.0
**创建日期**: 2026-01-18
**最后更新**: 2026-01-18
